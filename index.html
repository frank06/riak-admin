<!DOCTYPE HTML>

<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<title>riak-admin</title>

		<script src="jquery-1.4.1.min.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="jiak.js"></script>
    <link rel="stylesheet" href="rug.css" type="text/css" media="screen" charset="utf-8" />

    <script type="text/javascript" charset="utf-8">

      var db = new JiakClient('/jiak/');
      var bucket = window.location.search.substring(1);

      // db.store({'bucket':'test','object':{'text':'a new note'},'links':[]});

      $(function() {
        $('#bucket').html(bucket);
          db.fetch(bucket, "", function(response) {
            $.each(response.keys, function(i, key) {
              $('#keys')
                .append("<li id=\"" + uniqueId(bucket, key) + "\"><a href='javascript:;' onclick='show(\"" + key + "\")'>" + key +
                "</a></li>");
            });
          });
      });

      function uniqueId(bucket, key) {
        return bucket + "-" + key;
      }

      function cleanDetailPane() {
        $('#document').html("");
      }

      function edit(key) {
        $textarea = $("<textarea style='width:90%; height: 300px' />");
        $button = $("<button style>Save</button>").click(function(e) {
          // $t = $('#' + key + '-object pre textarea');
          // alert($t.val());
          // $('#' + key + '-object pre textarea').unwrap();
        });
        $('#' + key + '-object pre').wrapInner($textarea).append($button);
      }

      function del(key) {
        db.remove(bucket, key, function() {
          $('#keys > #' + uniqueId(bucket, key)).remove();
        });
      }

      function remove(key) {
        if (confirm("Sure you want to delete document " + key + " from bucket " + bucket + "?")) {
          del(key);
          cleanDetailPane();
        }
      }

      function deleteAll() {
        if (confirm("Are you ABSOLUTELY sure you want to delete ALL documents from bucket " + bucket + "?")) {
          db.fetch(bucket, "", function(response) {
            $.each(response.keys, function(i, key) {
              del(key);
            });
          });
          cleanDetailPane();
        }
      }

      function show(key) {
        db.fetch(bucket, key, function(response) {
          $('#document').html("<a href='javascript:;' onclick='remove(\"" + key + "\")'>delete</a> | " +
          "<a href='javascript:;' onclick='edit(\"" + key + "\")'>edit</a>");
          $.each(response, function(property, value) {
            $('#document').append("<dt>" + property + "<dt><dd id='" + key + "-" + property + "'><pre>" + JSON.stringify(value, null, 2) + "</pre></dd>");
          });
        });

      }

    </script>

	</head>

	<body>

    <h3>riak-admin &rarr; <small>bucket <em id="bucket"></em></small></h3>

	  <div style="float:left; width: 40%">
  	  <ul id="keys"></ul>
  	  <img src="trash.png" /> <small><a href="javascript:;" onclick="deleteAll()">Delete all documents of this bucket</a></small>
	  </div>
	  <div style="float:left; width: 60%">
      <dl id="document"></dl>
    </div>

    <div style="clear:both"></div>
    <hr/>

	</body>

</html>

<script type="text/javascript" charset="utf-8">
//
//
// row.find("td").makeEditable({allowEmpty: true,
//   createInput: function(value) {
//     if ($("dl", this).length > 0 || $("code", this).text().length > 60) {
//       return $("<textarea rows='8' cols='40' spellcheck='false'></textarea>");
//     }
//     return $("<input type='text' spellcheck='false'>");
//   },
//   end: function() {
//     $(this).children().remove();
//     $(this).append(_renderValue(doc[row.data("name")]));
//   },
//   prepareInput: function(input) {
//     if ($(input).is("textarea")) {
//       $(input).makeResizable({vertical: true});
//     }
//   },
//   accept: function(newValue) {
//     doc[row.data("name")] = JSON.parse(newValue);
//     page.isDirty = true;
//   },
//   populate: function(value) {
//     return $.futon.formatJSON(doc[row.data("name")]);
//   },
//   validate: function(value) {
//     try {
//       JSON.parse(value);
//       return true;
//     } catch (err) {
//       var msg = err.message;
//       if (msg == "parseJSON") {
//         msg = "Please enter a valid JSON value (for example, \"string\").";
//       }
//       $("<div class='error'></div>").text(msg).appendTo(this);
//       return false;
//     }
//   }
// });
</script>